<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SurveyX Testing</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <h1>SurveyX Testing</h1>

    <h2>Login</h2>
    <button onclick="login()">Login with Google</button>

    <h2>Create Survey</h2>
    <form id="createSurveyForm">
      <input
        type="text"
        id="surveyTitle"
        placeholder="Survey Title"
        required
      /><br />
      <textarea
        id="surveyDescription"
        placeholder="Survey Description"
      ></textarea
      ><br />
      <button type="submit">Create Survey</button>
    </form>

    <h2>My Surveys</h2>
    <button onclick="listSurveys()">List My Surveys</button>
    <div id="surveyList"></div>

    <h2>Submit Survey Response</h2>
    <form id="submitResponseForm">
      <input
        type="text"
        id="surveyLink"
        placeholder="Survey Link"
        required
      /><br />
      <div id="surveyQuestions"></div>
      <button type="submit">Submit Response</button>
    </form>

    <script>
      const API_URL = "http://localhost:8080";

      function login() {
        window.location.href = `${API_URL}/login`;
      }

      async function createSurvey(event) {
        event.preventDefault();
        const title = document.getElementById("surveyTitle").value;
        const description = document.getElementById("surveyDescription").value;

        try {
          const response = await axios.post(`${API_URL}/api/surveys`, {
            title,
            description,
            questions: [
              {
                text: "What's your favorite color?",
                type: "multiple_choice",
                options: [
                  { text: "Red", value: "red" },
                  { text: "Blue", value: "blue" },
                  { text: "Green", value: "green" },
                ],
                isRequired: true,
              },
              {
                text: "Any additional comments?",
                type: "text",
                isRequired: false,
              },
            ],
          });
          alert(`Survey created! Link: ${response.data.link}`);
        } catch (error) {
          console.error("Error creating survey:", error);
          alert("Failed to create survey");
        }
      }

      async function listSurveys() {
        try {
          const response = await axios.get(`${API_URL}/api/surveys`);
          const surveyListDiv = document.getElementById("surveyList");
          surveyListDiv.innerHTML = response.data
            .map(
              (survey) => `<p>Title: ${survey.Title}, Link: ${survey.Link}</p>`
            )
            .join("");
        } catch (error) {
          console.error("Error listing surveys:", error);
          alert("Failed to list surveys");
        }
      }

      async function loadSurveyQuestions(link) {
        try {
          const response = await axios.get(`${API_URL}/s/${link}`);
          const surveyQuestionsDiv = document.getElementById("surveyQuestions");
          surveyQuestionsDiv.innerHTML = response.data.Questions.map(
            (question) => {
              if (question.Type === "multiple_choice") {
                return `
                            <div>
                                <p>${question.Text}</p>
                                ${question.Options.map(
                                  (option) =>
                                    `<input type="radio" name="q_${question.ID}" value="${option.Value}"> ${option.Text}<br>`
                                ).join("")}
                            </div>
                        `;
              } else {
                return `
                            <div>
                                <p>${question.Text}</p>
                                <input type="text" name="q_${question.ID}">
                            </div>
                        `;
              }
            }
          ).join("");
        } catch (error) {
          console.error("Error loading survey questions:", error);
          alert("Failed to load survey questions");
        }
      }

      async function submitResponse(event) {
        event.preventDefault();
        const link = document.getElementById("surveyLink").value;
        const formData = new FormData(event.target);
        const answers = [];

        for (let [name, value] of formData.entries()) {
          if (name.startsWith("q_")) {
            answers.push({
              questionID: parseInt(name.split("_")[1]),
              value: value,
            });
          }
        }

        try {
          await axios.post(`${API_URL}/api/surveys/${link}/submit`, {
            answers,
          });
          alert("Response submitted successfully!");
        } catch (error) {
          console.error("Error submitting response:", error);
          alert("Failed to submit response");
        }
      }

      document
        .getElementById("createSurveyForm")
        .addEventListener("submit", createSurvey);
      document
        .getElementById("submitResponseForm")
        .addEventListener("submit", submitResponse);
      document
        .getElementById("surveyLink")
        .addEventListener("change", (e) => loadSurveyQuestions(e.target.value));
    </script>
  </body>
</html>
